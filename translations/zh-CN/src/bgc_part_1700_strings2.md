<!-- Beej's guide to C

# vim: ts=4:sw=4:nosi:et:tw=72
-->

# 字符和字符串 II

我们已经讨论过 `char` 类型实际上就是小整数类型......但对于单引号内的字符来说也是一样的。

但是双引号内的字符串是类型 `const char *`。

事实上，字符串和字符还有一些其他类型，而且这会引发语言中最臭名昭著的兔子洞问题之一：多字节/宽字符/Unicode/本地化问题。

我们将视察这个兔子洞，但暂时不会深入进去。 ... 现在!

## 转义序列

[i[转义序列]<]

我们习惯于在字符串和字符中使用常规字母、标点符号和数字：

``` {.c}
char *s = "Hello!";
char t = 'c';
```

但是，如果我们想要在其中加入一些无法用键盘键入的特殊字符（例如 "€"），或者即使我们想要一个单引号字符，我们显然无法这样做：

``` {.c}
char t = ''';
```

[i[`\` 反斜杠转义]<]

为了实现这些目的，我们使用一种被称为 _转义序列_ 的东西。这些是反斜杠字符（`\`）后跟另一个字符。这两个（或更多）字符一起具有特殊的含义。

对于我们的单引号字符示例，我们可以在中央单引号前面放一个转义符（即 `\`）来解决问题：

[i[`\'` 单引号]<]

``` {.c}
char t = '\'';
```

现在，C 知道 `\'` 表示我们想要打印的是一个普通的引号，而不是字符序列的结尾。

[i[`\'` 单引号]>]

在这种情况下，您可以说“反斜杠”或“转义”（“转义那个引号”），C 开发人员将明白您在说什么。此外，在这种情况下，“转义”与您的 `Esc` 键或 ASCII `ESC` 代码不同。

### 经常使用的转义字符

在我看来，这些转义字符占全部转义字符的99.2%^[我随便编的数字，但可能差不太多]。

|代码|描述|
|--|------------|
|[i[`\n` 换行符]]`\n`|换行符---打印时，在下一行继续输出|
|[i[`\'` 单引号]]`\'`|单引号---用于表示单引号字符常量|
|[i[`\"` 双引号]]`\"`|双引号---字符串字面值中的双引号|
|[i[`\\` 反斜杠]]`\\`|反斜杠---字符串或字符中的实际 `\`|

以下是转义字符的一些示例以及打印输出结果。

``` {.c}
printf("Use \\n for newline\n");  // Use \n for newline
printf("Say \"hello\"!\n");       // Say "hello"!
printf("%c\n", '\'');             // '
```

### 很少使用的转义字符

但还有更多转义字符！你可能不经常看到这些。

|代码|描述|
|--|------------|
|[i[`\a` 警报]]`\a`|警报。这会让终端发出声音或闪烁，有可能两者都会有！|
|[i[`\b` 退格]]`\b`|退格。将光标移回一个字符，不删除字符。|
|[i[`\f` 换页符]]`\f`|换页符。这会移动到下一个“页”，但在现代意义上并不多见。在我的系统上，这的表现类似于 `\v`。|
|[i[`\r` 回车]]`\r`|回车。移动到同一行的开头。|
|[i[`\t` 制表符]]`\t`|水平制表符。移动到下一个水平制表位置。在我的机器上，这会对齐8的倍数列，但不同系统可能有所不同。|
|[i[`\v` 垂直制表符]]`\v`|垂直制表符。移动到下一个垂直制表位置。在我的机器上，这会到达下一行的相同列。|
|[i[`\?` 问号]]`\?`|字面问号。有时你需要这个来避免三字符序列，如下所示。|

#### 单行状态更新

[i[`\b` 退格]<]
[i[`\r` 回车]<]

`\b` 或 `\r` 的一个用例是显示出现在屏幕同一行上的状态更新，而不会导致显示滚动。下面是一个从10开始倒计时的示例。（如果你的编译器不支持线程，你可以使用非标准 POSIX 函数 `sleep()` 来自 `<unistd.h>`---如果你不在类 Unix 系统上，请搜索你的平台和 `sleep` 来找到等效的函数。）

第7行发生了很多事情。首先，我们使用 `\r` 进入当前行的开头，然后用当前倒计时覆盖该位置。（这里使用了三元运算符来确保我们打印 `1 second` 而不是 `1 seconds`。）

另外，在 `...` 后面有一个空格。这样做是为了在 `i` 从 `10` 减少到 `9` 时能正确覆盖最后一个 `.`，使得列变窄。尝试去掉空格看看会发生什么。

最后，我们使用 `\b` 回退覆盖的空格，使得光标以一种美观的方式位于行末。

注意，第14行的末尾也有很多空格，以覆盖倒计时已经出现的字符。

最后，在这里我们有一个奇怪的 `fflush(stdout)`，不管那是什么意思。
简短的解释是，大多数终端默认是 _行缓冲_，意味着直到遇到换行符才会实际显示任何内容。由于我们没有换行符（只有 `\r`），如果没有这行代码，程序将在 `Liftoff!` 后一直停留，然后一次性打印所有内容。`fflush()` 覆盖了这种行为，强制立即发生输出。

#### 问号转义

为什么要费这个事呢？毕竟，这个也有效：

``` {.c}
printf("Doesn't it?\n");
```

而且使用逃脱符也可以：

``` {.c}
printf("Doesn't it\?\n");   // 注意 \?
```

那么，这有什么意义呢？！

让我们再加一个问号和一个感叹号来强调一下：

``` {.c}
printf("Doesn't it??!\n");
```

当我编译时，会收到以下警告：

``` {.zsh}
foo.c: In function ‘main’:
foo.c:5:23: warning: trigraph ??! converted to | [-Wtrigraphs]
    5 |     printf("Doesn't it??!\n");
      |    
```

运行程序会得到这个不太可能的结果：

``` {.default}
Doesn't it|
```

那么 _三字符编码_ 是什么鬼？！

我肯定在以后会回顾这个语言的古板之处，但简而言之，编译器会查找以 `??` 开头的特定三字符序列，并且会用其他字符替换它们。因此，如果你的键盘上没有管道符 (`|`)，你可以输入 `??!` 代替。

你可以通过转义第二个问号来解决这个问题，像这样：

``` {.c}
printf("Doesn't it?\?!\n");
```

然后它将被编译并按预期工作。

当然，如今几乎没有人再使用三字符序列。但如果你决定在字符串中使用它进行强调，整个'??!'偶尔还是会出现。

### 数字转义

此外，还有一些方法可在字符串或字符常量中指定数字常量或其他字符值。

如果你知道一个字节的八进制或十六进制表示，你可以在字符串或字符常量中包含它。

下表列有示例数字，但任何十六进制或八进制数字都可以使用。如有必要，用前导零填充以阅读正确的数字位数。

|代码|描述|
|--|------------|
|`\123`|包含八进制值`123`的字节，3位数字。|
|`\x4D`|包含十六进制值`4D`的字节，2位数字。|
|`\u2620`|包含Unicode字符，其代码点为十六进制值`2620`，4位数字。|
|`\U0001243F`|包含Unicode字符，其代码点为十六进制值`1243F`，8位数字。|

以下是一个使用较少见的八进制表示法表示大写字母`B`，位于`A`和`C`之间的示例。通常情况下，这将用于一些特殊的不可打印字符，但我们有其他方法来实现这一点，下面会讲到，这只是一个八进制演示：

``` {.c}
printf("A\102C\n");  // 102 对应ASCII/UTF-8中的 `B`
```

请注意：在这种方式下，八进制数没有前导零。但它确实需要三个字符，如果需要，请用前导零进行填充。

但是如今更常见的做法是使用十六进制常量。这里有一个演示，你不应该使用，但它展示了将UTF-8字节0xE2、0x80和0xA2嵌入字符串中，对应于Unicode的"bullet"字符（•）。

``` {.c}
printf("\xE2\x80\xA2 Bullet 1\n");
printf("\xE2\x80\xA2 Bullet 2\n");
printf("\xE2\x80\xA2 Bullet 3\n");
```

如果你在UTF-8控制台上，将产生以下输出（或者如果你不是就可能是垃圾）：

``` {.default}
• Bullet 1
• Bullet 2
• Bullet 3
```

但这是一个糟糕的Unicode处理方式。你可以使用`\u`（16位）或`\U`（32位）来通过码点号码引用Unicode。子弹符号在Unicode中是`2022`（十六进制），所以你可以这样做并获得更具移植性的结果：

``` {.c}
printf("\u2022 Bullet 1\n");
printf("\u2022 Bullet 2\n");
printf("\u2022 Bullet 3\n");
```

确保在`\u`前加足够数量的前导零以达到四个字符，而在`\U`前加足够数量的前导零以达到八个字符。

例如，该子弹可以用`\U`和四个前导零来表示：

``` {.c}
printf("\U00002022 Bullet 1\n");
```

但是谁有时间如此冗长呢？